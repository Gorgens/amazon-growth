---
title: "Resultados"
output: html_document
---

```{r pacotes3}
require(tidyverse)
require(magrittr)
require(reshape2)
require(ggplot2)
require(V.PhyloMaker)
require(phytools)
require(rstanarm)
require(bayesplot)
require(forestmangr)
```

Frequência de indivíduos por grupo ecológico...

```{r proporcaoGruposEcologicos, echo=FALSE}
arvHaEspecie = invMerged %>%
  drop_na(GrupoEco) %>%
  filter(DBH >= 10) %>%
  group_by(area, plot, subplot, year, GrupoEco) %>% 
  summarise(ntree = sum(eqTree)) %>%
  drop_na(ntree) %>%
  group_by(area, plot, subplot, GrupoEco) %>%
  summarise(ntree = mean(ntree)) %>%
  group_by(area, GrupoEco) %>%
  summarise(ntree = sum(ntree)) %>%
  left_join(parcelasArea) %>%
  mutate(arvha = ntree / nplots) %>%
  group_by(GrupoEco) %>%
  summarise(arvha = mean(arvha)) %>%
  filter(GrupoEco != "OUTROS") %>%
  mutate(arvProp = arvha / sum(arvha) * 100)

arvHaEspecie
```

Incremento pelo grupo ecológico...

```{r mediaIncrementoGruposEcologicos, echo=FALSE}
incrementoGrupo = incEco %>%
  filter(GrupoEco != "OUTROS") %>%
  group_by(GrupoEco) %>%
  summarise(incDesv = IQR(rInc, na.rm = TRUE), 
            rInc = median(rInc))

incrementoGrupo
```

```{r estaticaGrupoEcologico, echo=FALSE}
incGrupoEco <- stan_glm(
  rInc ~ GrupoEco,
  data = incEco,
  family = Gamma(link="log"))
```

```{r}
bayesplot::color_scheme_set("viridis")
plot(incGrupoEco, plotfun = "areas", prob = 0.9, regex_pars = c("(Intercept)", "Grupo"))
```

```{r}
numeroArvores = invMerged %>%
  filter(GrupoEco != "OUTROS") %>%
  filter(DBH >= 10) %>%
  group_by(area, plot, subplot, year, GrupoEco, cc) %>% 
  summarise(ntree = sum(eqTree))  %>%
  drop_na(ntree) %>%
  group_by(area, GrupoEco, cc) %>%
  summarise(narv = sum(ntree)) %>%
  left_join(parcelasArea) %>%
  mutate(arvha = narv / nplots) %>%
  group_by(GrupoEco, cc) %>%
  summarise(arvha = mean(arvha))

ggplot(numeroArvores, aes(cc, arvha)) + geom_col() +
  xlab('Diameter distribution') + ylab('Trees per hectare') +
  theme_bw() + theme(panel.grid.major = element_blank(),
                     panel.grid.minor = element_blank(),
                     panel.background = element_blank(),
                     axis.line = element_line(colour = "black")) +
  facet_wrap(~GrupoEco, ncol = 5)
```


```{r}
grupo = "Pioneer"

numeroArvores = invMerged %>%
  filter(GrupoEco == grupo) %>%
  filter(DBH >= 10) %>%
  group_by(area, plot, subplot, year, cc) %>% 
  summarise(ntree = sum(eqTree))  %>%
  drop_na(ntree) %>%
  group_by(area, cc) %>%
  summarise(narv = sum(ntree)) %>%
  left_join(parcelasArea) %>%
  mutate(arvha = narv / nplots) %>%
  group_by(cc) %>%
  summarise(arvha = mean(arvha))

meyerPioneiras = lm(log(arvha)~cc, data = numeroArvores)
summary(meyerPioneiras)
```

```{r}
grupo = "Light-demanding"

numeroArvores = invMerged %>%
  filter(GrupoEco == grupo) %>%
  filter(DBH >= 10) %>%
  group_by(area, plot, subplot, year, cc) %>% 
  summarise(ntree = sum(eqTree))  %>%
  drop_na(ntree) %>%
  group_by(area, cc) %>%
  summarise(narv = sum(ntree)) %>%
  left_join(parcelasArea) %>%
  mutate(arvha = narv / nplots) %>%
  group_by(cc) %>%
  summarise(arvha = mean(arvha))

meyerLight = lm(log(arvha)~cc, data = numeroArvores)
summary(meyerLight)
```

```{r}
grupo = "Intermediate"

numeroArvores = invMerged %>%
  filter(GrupoEco == grupo) %>%
  filter(DBH >= 10) %>%
  group_by(area, plot, subplot, year, cc) %>% 
  summarise(ntree = sum(eqTree))  %>%
  drop_na(ntree) %>%
  group_by(area, cc) %>%
  summarise(narv = sum(ntree)) %>%
  left_join(parcelasArea) %>%
  mutate(arvha = narv / nplots) %>%
  group_by(cc) %>%
  summarise(arvha = mean(arvha))

meyerIntermediarias = lm(log(arvha)~cc, data = numeroArvores)
summary(meyerIntermediarias)
```

```{r}
grupo = "Shade-tolerant"

numeroArvores = invMerged %>%
  filter(GrupoEco == grupo) %>%
  filter(DBH >= 10) %>%
  group_by(area, plot, subplot, year, cc) %>% 
  summarise(ntree = sum(eqTree))  %>%
  drop_na(ntree) %>%
  group_by(area, cc) %>%
  summarise(narv = sum(ntree)) %>%
  left_join(parcelasArea) %>%
  mutate(arvha = narv / nplots) %>%
  group_by(cc) %>%
  summarise(arvha = mean(arvha))

meyerShade = lm(log(arvha)~cc, data = numeroArvores)
summary(meyerShade)
```

```{r}
grupo = "Emergent"

numeroArvores = invMerged %>%
  filter(GrupoEco == grupo) %>%
  filter(DBH >= 10) %>%
  group_by(area, plot, subplot, year, cc) %>% 
  summarise(ntree = sum(eqTree))  %>%
  drop_na(ntree) %>%
  group_by(area, cc) %>%
  summarise(narv = sum(ntree)) %>%
  left_join(parcelasArea) %>%
  mutate(arvha = narv / nplots) %>%
  group_by(cc) %>%
  summarise(arvha = mean(arvha))

meyerEmergentes = lm(log(arvha)~cc, data = numeroArvores)
summary(meyerEmergentes)
```

```{r}

ccNew = data.frame(cc = seq(15, 245, 10))
nArvPioneiras = round(exp(predict(meyerPioneiras, newdata = ccNew)), 1)
nArvLight = round(exp(predict(meyerLight, newdata = ccNew)), 1)
nArvIntermediarias = round(exp(predict(meyerIntermediarias, newdata = ccNew)), 1)
nArvShade = round(exp(predict(meyerShade, newdata = ccNew)), 1)
nArvEmergentes = round(exp(predict(meyerEmergentes, newdata = ccNew)), 1)
nArvPatterns = data.frame(ccNew, Pion = nArvPioneiras,Light = nArvLight, Inter = nArvIntermediarias, Shade = nArvShade, Emer = nArvEmergentes)

pairs(nArvPatterns)
```

```{r}
graybill_f(nArvPatterns, "Light", "Emer", signif = 0.05, output = "simple")
```


```{r}
graybill_f(nArvPatterns, "Pion", "Shade", signif = 0.05, output = "simple")
```

