---
title: "Resultados"
output: html_document
---


```{r pacotes3, echo=FALSE, warning=FALSE}
require(tidyverse)
require(magrittr)
require(reshape2)
require(rstanarm)
require(bayesplot)
require(ggplot2)
require(gridExtra)
```

Das 415 espécies inventariadas, 90 foram associadas a um dos 5 grupos ecológicos: 13 espécies foram assinaladas como pioneiras, 13 como demadantes de luz, 34 como intermediárias, 20 como tolerantes à sombra e 10 como emergentes. O grupo ecológico das demandantes de luz apresentou o maior incremento diamétrico relativo esperado e também a maior variação: mediana de 1.7% ao ano, com distância interquartil de 3.0%. Em ordem decrescente, observou-se o grupo das pioneiras (0.9%, IQR: 1.6%), das intermediárias (0.7%, IQR: 1.3%), das emergentes (0.6%, IQR: 1.8%) e das tolerantes à sombra (0.6%, IQR: 1.0%) (Table \@ref(tab:tableR1)).   

```{r proporcaoGruposEcologicos, echo=FALSE, warning=FALSE}
arvHaEspecie = invMerged %>%
  drop_na(GrupoEco) %>%
  filter(DBH >= 10) %>%
  group_by(area, year, plot, subplot, GrupoEco) %>% 
  summarise(ntree = sum(eqTree)) %>%
  drop_na(ntree) %>%
  group_by(area, year, plot, GrupoEco) %>%
  summarise(ntree = mean(ntree)) %>%
  group_by(area, year,  GrupoEco) %>%
  summarise(ntree = sum(ntree)) %>%
  left_join(parcelasArea) %>%
  mutate(arvha = ntree / nplots) %>%
  group_by(area, GrupoEco) %>%
  summarise(arvha = mean(arvha)) %>%
  group_by(GrupoEco) %>%
  summarise(arvha = mean(arvha)) %>%
  filter(GrupoEco != "Others") %>%
  mutate(arvProp=arvha/sum(arvha)*100)

incrementoGrupo = incEco %>%
  filter(GrupoEco != "Others") %>%
  group_by(GrupoEco) %>%
  summarise(incDesv = IQR(rInc, na.rm = TRUE), 
            rInc = median(rInc))
```

```{r tableR1, echo=FALSE, warning=FALSE}
knitr::kable(
  inner_join(arvHaEspecie, incrementoGrupo, by = 'GrupoEco') %>%
    select(GrupoEco, arvProp, incDesv, rInc),
  caption = 'Resumo dos grupos ecológicos.'
    )
```

O grupo das emergentes é o menor grupo, contendo 3.1% das árvores. O grupo mais numeroso é o grupo das intermediárias (31%) seguindo pelo grupo das tolerantes a sombra (29%). Os grupos das pioneiras e das demantantes de luz representam as demais espécies, numa porporção de 17% e 19% respectivamente (Table \@ref(tab:tableR1)).

A partir do modelo linear generalizado bayesiano, observa-se que o grupo das demandantes de luz possui um parâmetro que difere dos demais grupos que estão alinhados. Os grupos (Figure \@ref(fig:testeIncGrupoEco)). Tendo o grupo das Emergentes como referência (intercept), os grupos Intermediárias e Pionerias em média possuem a mesma taxa de incremento relativo (distribuição engloba o zero). O grupo das tolerantes a sombra possui um tendência de apresentar taxa de incrementos relativos menores que o grupo das emergentes. Já o grupo das demandantes de luz possuem uma taxa de crescimento relativo superior ao grupo das emergentes.

```{r testeIncGrupoEco, echo=FALSE, warning=FALSE, cache=TRUE, fig.cap = 'Análise bayesiana comparando o incremento relativo entre grupos ecológicos.'}
incGrupoEco <- stan_glm(
  rInc ~ GrupoEco,
  data = incEco,
  family = Gamma(link="log"))

bayesplot::color_scheme_set("viridis")
plot(incGrupoEco, plotfun = "areas", prob = 0.9, regex_pars = c("(Intercept)", "Grupo"))
```

Como resultado da análise bayesiana, em relação à taxa de crescimento diamétrico relativo, os grupos ecológicos podem ser separados em três agrupamentos: um contendo os grupos das emergentes, das pioneiras e das intermediária; outro contendo apenas as demandantes de luz e outro contendo apenas as tolerantes a sombra.

A distribuição diamétrica de todos os grupos ecológicos apresentaram forte assimetria a esquerda, com um  comportamento exponencial negativo, também conhecido como "J-invertido", mas com taxas de descréscimo diferentes (Figure \@ref(fig:graficoDDGrupoEco)). O grupo das emergentes apesar de também apresentar uma forma expoencial, o decréscimo entre classes foi inferior se comparados aos demais grupos (diferenças menores entre os números de árvores das classes diamétricas). 

```{r graficoDDGrupoEco, echo=FALSE, warning=FALSE, fig.cap = 'Distribuição diamétrica para cada grupo ecológico.'}
numeroArvores = invMerged %>%
  filter(GrupoEco != "Others") %>%
  filter(DBH >= 10) %>%
  group_by(area, year, plot, subplot, GrupoEco, cc) %>% 
  summarise(ntree = sum(eqTree))  %>%
  drop_na(ntree) %>%
  group_by(area, year, plot, GrupoEco, cc)%>%
  summarise(ntree = mean(ntree)) %>%
  group_by(area, year, GrupoEco, cc)%>%
  summarise(ntree = sum(ntree)) %>%
  left_join(parcelasArea) %>%
  mutate(arvha = ntree/ nplots) %>%
  group_by(area, GrupoEco, cc) %>%
  summarise(arvha = mean(arvha)) %>%
  group_by(GrupoEco, cc) %>%
  summarise(arvha = mean(arvha)) 


ggplot(numeroArvores, aes(cc, arvha)) + geom_col() +
  xlab('Diameter distribution') + ylab('Trees per hectare') +
    theme_bw() + theme(panel.grid.major = element_blank(),
                     panel.grid.minor = element_blank(),
                     panel.background = element_blank(),
                     axis.line = element_line(colour = "black"))+
  facet_wrap(~GrupoEco, ncol=5)


```

O coeficiente angular do modelo de Meyer linearizado evidencia o grupo ecológico das emergentes com a menor taxa de decréscimo (Figure \@ref(fig:testeArvGrupoEco)). Já o grupo das pioneiras possui a maior taxa de decréscimo. Os grupos das intermediárias, das tolerantes a sombra e das demantantes de luz ocupam postos entre os grupos já mencionados, em posições crescentes. O interceto do modelo, indica o grupo das emergentes apresentando o menor número de árvores na classe inicial dentre os grupos. Seguido pelas demandantes de luz, e por um grupo formado pelas intermediárias, pioneiras e tolerantes à sombra, com a maior quantidade de indivíduos na classe diamétrica inicial. 

```{r testeArvGrupoEco, echo=FALSE, warning=FALSE, fig.cap = 'Análise bayesiana comparando a taxa de descréscimo exponencial para o número de árvores por classe diamétrica entre grupos ecológicos.'}
numeroArvoresPorCC= invMerged %>%
  filter(GrupoEco != "Others") %>%
  filter(DBH >= 10) %>%
  group_by(area, year, plot, subplot, GrupoEco, cc) %>% 
  summarise(ntree = sum(eqTree))  %>%
  drop_na(ntree) %>%
  group_by(area, year, plot, GrupoEco, cc)%>%
  summarise(ntree = mean(ntree)) %>%
  group_by(area, year, GrupoEco, cc)%>%
  summarise(ntree = sum(ntree)) %>%
  left_join(parcelasArea) %>%
  mutate(logArvha = log(ntree/ nplots))

arvGrupoEco = stan_glm(
  logArvha ~ -1 + GrupoEco + cc:GrupoEco, 
  data=numeroArvoresPorCC, 
  family=gaussian(link="identity"))
  
bayesplot::color_scheme_set("viridis")

plot1 = mcmc_areas(arvGrupoEco, pars=vars(contains(":cc")))
plot2 = mcmc_areas(arvGrupoEco, pars=vars(!contains(":cc") & contains("Grupo")))

grid.arrange(plot2, plot1, ncol=2)

```



