---
title: "Resultados"
output: html_document
---

```{r pacotes3, warning=FALSE, echo=FALSE}
require(tidyverse)
require(magrittr)
require(reshape2)
require(ggplot2)
require(gridExtra)
require(V.PhyloMaker)
require(phytools)
require(rstanarm)
require(bayesplot)
require(forestmangr)
```

Frequência de indivíduos por grupo ecológico...

```{r proporcaoGruposEcologicos, warning=FALSE, echo=FALSE}
arvHaEspecie = invMerged %>%
  drop_na(GrupoEco) %>%
  filter(DBH >= 10) %>%
  group_by(area, year, plot, subplot, GrupoEco) %>% 
  summarise(ntree = sum(eqTree)) %>%
  drop_na(ntree) %>%
  group_by(area, year, plot, GrupoEco) %>%
  summarise(ntree = mean(ntree)) %>%
  group_by(area, year, GrupoEco) %>%
  summarise(ntree = sum(ntree)) %>%
  left_join(parcelasArea) %>%
  mutate(arvha = ntree / nplots) %>% 
  group_by(area, GrupoEco) %>%
  summarise(arvha = mean(arvha)) %>%
  group_by(GrupoEco) %>%
  summarise(arvha = mean(arvha)) %>%
  filter(GrupoEco != "Others") %>%
  mutate(arvProp = arvha / sum(arvha) * 100)

arvHaEspecie
```

Incremento pelo grupo ecológico...

```{r mediaIncrementoGruposEcologicos, warning=FALSE, echo=FALSE}
incrementoGrupo = incEco %>%
  filter(GrupoEco != "Others") %>%
  group_by(GrupoEco) %>%
  summarise(incDesv = IQR(rInc, na.rm = TRUE), 
            rInc = median(rInc))

incrementoGrupo
```

```{r testeIncGrupoEcologico, warning=FALSE, echo=FALSE}
incGrupoEco <- stan_glm(
  rInc ~ GrupoEco,
  data = incEco,
  family = Gamma(link="log"))
```

```{r bayesplotIncGrupoEco, warning=FALSE, echo=FALSE}
bayesplot::color_scheme_set("viridis")
plot(incGrupoEco, plotfun = "areas", prob = 0.9, regex_pars = c("(Intercept)", "Grupo"))
```

```{r graficoDDgrupoEco, warning=FALSE, echo=FALSE}
numeroArvores = invMerged %>%
  filter(GrupoEco != "Others") %>%
  filter(DBH >= 10) %>%
  group_by(area, year, plot, subplot, GrupoEco, cc) %>% 
  summarise(ntree = sum(eqTree))  %>%
  drop_na(ntree) %>%
  group_by(area, year, plot, GrupoEco, cc) %>%
  summarise(ntree = mean(ntree)) %>%
  group_by(area, year, GrupoEco, cc) %>%
  summarise(ntree = sum(ntree)) %>%
  left_join(parcelasArea) %>%
  mutate(arvha = ntree / nplots) %>%
  group_by(area, GrupoEco, cc) %>%
  summarise(arvha = mean(arvha)) %>%
  group_by(GrupoEco, cc) %>%
  summarise(arvha = mean(arvha))

ggplot(transform(numeroArvores,
                 GrupoEco = factor(GrupoEco, levels=c('Pioneer',
                                                      'Light-demanding',
                                                      'Intermediate',
                                                      'Shade-tolerant',
                                                      'Emergent'))),
       aes(cc, arvha)) + 
  geom_col() +
  xlab('Diameter distribution') + ylab('Trees per hectare') +
  theme_bw() + theme(panel.grid.major = element_blank(),
                     panel.grid.minor = element_blank(),
                     panel.background = element_blank(),
                     axis.line = element_line(colour = "black")) +
  facet_wrap(~GrupoEco, ncol = 5)
```

```{r testeArvGrupoEco, warning=FALSE, echo=FALSE}
numeroArvoresPorCc = invMerged %>%
  filter(GrupoEco != "Others") %>%
  filter(DBH >= 10) %>%
  group_by(area, year, plot, subplot, GrupoEco, cc) %>% 
  summarise(ntree = sum(eqTree))  %>%
  drop_na(ntree) %>%
  group_by(area, year, plot, GrupoEco, cc) %>%
  summarise(ntree = mean(ntree)) %>%
  group_by(area, year, GrupoEco, cc) %>%
  summarise(ntree = sum(ntree)) %>%
  left_join(parcelasArea) %>%
  mutate(arvha = ntree / nplots)

arvGrupoEco <- stan_glm(
  arvha ~ cc:GrupoEco,
  data = numeroArvoresPorCc,
  family = Gamma(link="log"))
```

```{r bayesplotArvGrupoEco, warning=FALSE, echo=FALSE}
bayesplot::color_scheme_set("viridis")
#plot(arvGrupoEco, plotfun = "areas", prob = 0.9, regex_pars = c("(Intercept)", "Grupo"))

plot1 = mcmc_intervals(arvGrupoEco, pars = vars(contains("cc:GrupoEco")))
plot2 = mcmc_intervals(arvGrupoEco, pars = vars(contains("Intercept")))

grid.arrange(plot2, plot1, ncol=2)
```

